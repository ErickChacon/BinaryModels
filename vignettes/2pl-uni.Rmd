---
title: "Two Parameter Logistic Model"
author: "Erick A. Chacon-Montalvan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Two Parameter Logistic Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
knitr::opts_chunk$set(fig.width = 6, fig.height = 4)
knitr::opts_chunk$set(comment = "#>")
options(width = 100)
# fig.show = 'hold'
```

In this vignette, we show how to use the package to fit a 2 parameter model.

## Required packages

```{r}
rm(list = ls())
library(tidyverse)
library(day2day)
library(spmirt)
library(coda)
```

## Simulation of the data

```{r}

q <- 10
n <- 300
nq <- n * q
sigma <- 1
discrimination <- seq(0.4, 1.5, length.out = q)
# discrimination <- rep(1, q)
difficulty <- (1:q - 5)/10 * 2
# difficulty <- rep(0, q)
ability <- rnorm(n, 0, sigma)
data_long <- expand.grid(subject = 1:n, item = 1:q) %>% mutate(
  ability = ability[subject],
  difficulty = difficulty[item],
  discr = discrimination[item],
  y = rbinom(n * q, 1, psych::logistic(1.702 * (discr * ability - difficulty))),
  # y = rbinom(n * q, 1, psych::logistic(discr * (ability - difficulty))),
  # y_logit = rbinom(n * q, 1, psych::logistic(discr * ability - difficulty)),
  # y_probit = rbinom(n * q, 1, psych::logistic(1.702 * (discr * ability - difficulty)))
  )

bla <- data_long %>% as_tibble() %>% group_by(subject) %>%
  summarize(a1 = mean(y), abil = mean(ability))
ggplot(bla, aes(abil, a1)) + geom_point()

data_long %>% as_tibble() %>% group_by(item) %>% summarize(easiness = mean(y))
bla <- data_long %>% as_tibble() %>% group_by(subject) %>% summarize(ability = mean(y))
table(bla$ability)


```

## Fitting the model

```{r}
ini <- Sys.time()
samples <- ifa_gibbs(data_long$y, n, q, 1000)
print(Sys.time() - ini)
```

## Evaluate the results

```{r}
samples2 <- samples %>% purrr::map(~ .[501:1000, ])
# samples2 <- samples %>% purrr::map(~ .[2501:5000, ])
means <- purrr::map(samples2, ~ apply(., 2, mean))
medians <- purrr::map(samples2, ~ apply(., 2, median))

plot(difficulty, -means$c)
points(difficulty, -medians$c, col = 2)
abline(0, 1)

c_sam <- mcmc(-samples2$c)
plot(c_sam)

plot(discrimination, means$a)
abline(0, 1)
abline(0, -1)

a_sam <- mcmc(samples2$a)
plot(a_sam)

plot(ability, means$theta)
abline(0, 1)
abline(0, -1)
```
